
## ✅ 基本ルール（前提）

* `requirements.txt` は「**この環境ではこれが動いた**」というスナップショットとして使うべき。
* 他人や将来の自分が、**同じ環境を再現できること**が目的。
* `pip freeze` で生成したファイルだけでは、**バージョン制約がないパッケージの氾濫**により危険。

---

## ✅ 適切な記述方法（開発時）

`requirements.in` などの**手書きファイル**に制約を明記する：

```txt
fastapi>=0.105,<0.107
aiohttp==3.9.1
sqlalchemy~=2.0
pytest>=8.0.0,<9.0.0
```

| 記法           | 意味                | 備考                |
| ------------ | ----------------- | ----------------- |
| `==1.2.3`    | 完全固定              | 再現性高いが柔軟性なし       |
| `>=1.2,<1.3` | 厳格な範囲指定           | 将来壊れないがアップデートも可能  |
| `~=1.2.3`    | `>=1.2.3, <1.3.0` | マイナーバージョンの中で最新を使う |
| `>=1.2.0`    | 最小バージョンのみ         | 一番危険。再現性なし        |

---

## ✅ freezeの使い方（本番用）

開発環境で問題なく動作した後、**その環境をスナップショットとして記録**する：

```bash
pip freeze > requirements.txt
```

この `requirements.txt` は以下のような完全固定リストになる：

```txt
fastapi==0.106.0
aiohttp==3.9.1
attrs==23.2.0
pytest==8.1.1
```

これは**デプロイ時やCI/CD時**に使う：

```bash
pip install -r requirements.txt
```

---

## ✅ よくある誤りと対処

| 誤り                                      | 問題点               | 解決策                              |
| --------------------------------------- | ----------------- | -------------------------------- |
| `requirements.txt` に手書きで `fastapi` のみ記載 | 最新が入る → **壊れる**   | 最低でも `>=x.y,<z.w` 指定すべき          |
| `pip freeze` をコミットしない                   | チームで環境差異 → 再現できない | `requirements.txt` は常にロックとして扱うべき |
| `pip install fastapi` を都度実行             | バージョンばらつき         | 必ず `-r requirements.txt` 経由で統一せよ |

---

## ✅ pip-toolsの導入（中級以上）

以下のような2段階構成を採用：

* `requirements.in`: 手書き、制約を記述
* `requirements.txt`: 自動生成、ロックファイル

```bash
pip install pip-tools
pip-compile requirements.in  # requirements.txt を生成
```

これは `poetry.lock` に近い役割を果たす。管理しやすい。

---

## ✅ まとめ：バージョン管理の戦略

| 用途       | 方法                                                |
| -------- | ------------------------------------------------- |
| 開発       | `requirements.in` に制約記述（または `pyproject.toml`）     |
| デプロイ・CI  | `requirements.txt` を固定（`freeze` or `pip-compile`） |
| 本番環境の再現性 | `==` 固定 or `pip-compile` 生成物を使用                   |

---
