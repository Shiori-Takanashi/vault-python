
## pip-toolsとは何か

`pip-tools` は、**Pythonパッケージの依存関係を安全に・再現可能に管理するためのツール群**。特に以下の2つのCLIが提供される：

* `pip-compile`：
  → 人間が書いた簡潔な制約ファイル（`requirements.in`）を元に、**すべての依存パッケージのバージョンを固定した `requirements.txt` を生成**する。
* `pip-sync`：
  → `requirements.txt` に記載されたパッケージと\*\*完全に一致するように現在の環境を同期（インストール・アンインストール）\*\*する。

---

## なぜ必要か

`pip freeze` だけでは以下の問題がある：

| 問題点            | 説明                                  |
| -------------- | ----------------------------------- |
| **制約の意図が失われる** | すべて `==` 固定になり、どの依存が直接のものか判別不能      |
| **再現性の保証が弱い**  | チームやCI/CDで環境差異が発生しやすい               |
| **アップデート困難**   | `freeze` はバージョンの由来を記録しないため安全な更新が難しい |

---

## 基本構成とファイル例

* `requirements.in`：人が書く。直接使うパッケージと制約を記述。
* `requirements.txt`：機械が生成。依存パッケージすべてを `==` 固定。

### 例：

#### requirements.in（手書き）

```txt
fastapi>=0.105,<0.107
aiohttp==3.9.1
pytest
```

#### pip-compile により生成された requirements.txt（自動）

```txt
# This file is autogenerated by pip-compile
aiohttp==3.9.1
attrs==23.2.0       # via aiohttp
fastapi==0.106.0
pydantic==2.7.1     # via fastapi
pytest==8.2.0
...
```

---

## コマンド一覧

```bash
# 1. インストール
pip install pip-tools

# 2. ロックファイル生成
pip-compile requirements.in

# 3. インストール（再現性あり）
pip install -r requirements.txt

# 4. 環境の同期（余分なパッケージ削除）
pip-sync requirements.txt
```

---

## 利点と欠点

| 項目             | 内容                                  |
| -------------- | ----------------------------------- |
| ✅ 再現性          | `==` で固定された完全な環境を得られる               |
| ✅ 可読性          | 依存の由来がコメントに記録される                    |
| ✅ 安全性          | 上位パッケージだけ意識して管理できる                  |
| ❌ 複雑性          | `requirements.in` / `.txt` の2重管理が必要 |
| ❌ poetryとの互換なし | `pyproject.toml` とは連携不可（pip専用）      |

---

## よくある使い方（構成例）

```txt
.
├── requirements.in         # 本番依存のみ
├── requirements.txt        # ロックファイル
├── requirements-dev.in     # 開発用依存（pytest, blackなど）
├── requirements-dev.txt
```

### 例：開発環境セットアップ手順

```bash
pip-compile requirements.in
pip-compile requirements-dev.in
pip-sync requirements.txt requirements-dev.txt
```

---
以下に、**Obsidian用のノート形式**で `pip-tools` の使い方とコマンドを網羅的に整理します。

---

## pip-tools の使い方とコマンド一覧

### 🔧 1. インストール

```bash
pip install pip-tools
```

---

## 📁 ファイル構成

| ファイル               | 役割                            | 編集対象      |
| ------------------ | ----------------------------- | --------- |
| `requirements.in`  | 人間が記述する依存ファイル                 | ✅         |
| `requirements.txt` | `pip-compile` で自動生成されるロックファイル | ❌（手動編集不可） |

必要に応じて開発用も分ける：

```txt
requirements.in
requirements.txt
requirements-dev.in
requirements-dev.txt
```

---

## 📌 2. ロックファイルの生成：`pip-compile`

```bash
pip-compile requirements.in
```

### 引数つきの例：

```bash
pip-compile --output-file=requirements.txt requirements.in
pip-compile requirements-dev.in --extra dev
```

> `requirements.txt` にすべての依存パッケージを `==` 固定で出力。
> コメントに「どのパッケージから依存されたか」も残る。

---

## 📦 3. パッケージのインストール：`pip install`

```bash
pip install -r requirements.txt
```

### 併用例：

```bash
pip install -r requirements.txt -r requirements-dev.txt
```

---

## 🧹 4. 環境をロックファイルに同期：`pip-sync`

```bash
pip-sync requirements.txt
```

> 指定されたファイルに記載されたパッケージ**以外を削除**。
> その環境を**完全に再現可能な状態にする**。

### 複数ファイル対応：

```bash
pip-sync requirements.txt requirements-dev.txt
```

---

## 🔁 5. パッケージ追加と更新

### 依存追加（手動で `requirements.in` を編集）：

```txt
# requirements.in
fastapi>=0.105,<0.107
aiohttp==3.9.1
```

### 反映：

```bash
pip-compile requirements.in
```

---

## ⚙️ 6. その他オプション

| オプション                     | 内容                              |
| ------------------------- | ------------------------------- |
| `--upgrade`               | すべての依存を最新に更新                    |
| `--upgrade-package <pkg>` | 特定パッケージだけ更新                     |
| `--generate-hashes`       | セキュリティ強化のため `hash=` を追加（PyPI署名） |
| `--annotate`              | 依存元をコメントで表示（デフォルト：有効）           |

---

## 🧪 使用例（最低限構成）

```txt
# requirements.in
requests>=2.28
```

```bash
pip-compile
pip install -r requirements.txt
```

---

## 🚫 注意点

* `requirements.txt` は**絶対に手動編集しない**
* `pip-sync` は**未指定のパッケージを削除**するため注意（開発中に非管理パッケージがある場合）

---

## 🧰 まとめコマンド

```bash
# 初期セットアップ
pip install pip-tools

# lockファイル生成
pip-compile requirements.in

# パッケージインストール
pip install -r requirements.txt

# 環境をロックファイルに完全同期（他を削除）
pip-sync requirements.txt
```

---


## 結論

* `pip-tools` は **pip環境での再現性ある依存管理**を実現するための現実的手段
* `poetry` を導入しない現場や、Docker環境で軽量に済ませたいプロジェクトに適する
* 一方で、**初心者にはやや取っつきづらく、構成理解が必要**

---

