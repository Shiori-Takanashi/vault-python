---
title: 
keyword: 
created: 2025-08-07 11:43
modified: 2025-08-07 11:43
vault: Python
catergory: Language
language: Python
area: Standard_Library
identify:  
type: Lesson...
tole: Index
order: 00
---



# 📢Pytest-Lesson

---

## 📍 第01部：pytestの基礎

---

### 第01章：pytestとは何か

* `unittest` との違いと利点
* シンプルな記述スタイル
* インストールと基本実行方法

### 第03章：pytestコマンド入門

* `pytest` の基本オプション
* `-v`・`-q`・`--maxfail` の活用
* ファイル／関数／マークの絞り込み実行

### 第02章：テスト関数の基本形

* `test_` から始まる関数定義
* `assert` 文による検証
* テスト結果の読み方

### 第04章：失敗時の出力

* エラー内容の表示構造
* `AssertionError` の詳細確認
* トレースバックの見方と修正のヒント

### 第05章：引数付きテスト関数

* `@pytest.mark.parametrize` の基礎
* 複数パターンをまとめてテスト
* 失敗パターンの特定

### 第06章：例外のテスト

* `with pytest.raises()` の使用法
* 例外メッセージの検証
* 異常系の網羅と品質向上

---

以下は、`pytest` に関するカリキュラムの「第02部：pytestコマンドの詳解」です。実務で多用されるオプションや実行制御に焦点を当てています。

---

## 📍 第02部：pytestコマンドの詳解

---

### 第07章：テスト対象の絞り込み

* 関数名・クラス名の指定実行
* ファイル単位／ディレクトリ単位での実行
* `-k` オプションによる名前フィルタ

### 第08章：マークによる分類実行

* `@pytest.mark.slow` などの定義と付与
* `-m` オプションでのマーク実行
* カスタムマークの登録と警告回避

### 第09章：出力フォーマットの制御

* `-v`（verbose）と `-q`（quiet）の使い分け
* `--tb=short`・`--tb=none` でトレースバック制御
* `--maxfail` による早期停止設定

### 第10章：詳細な失敗情報の取得

* `--showlocals` でローカル変数出力
* `--capture=no` による標準出力の表示
* `--durations` で遅いテストの特定

### 第11章：実行対象の検出と除外

* `conftest.py` や `__init__.py` の影響
* `--pyargs` によるモジュール指定
* `--ignore`・`--deselect` での対象除外

### 第12章：リトライとフレーク対策

* `pytest-rerunfailures` プラグインの利用
* `--reruns N` の指定と `--reruns-delay`
* 安定性向上と報告品質の向上

---

以下は「第03部：テスト関数のベストプラクティス」です。pytestを使う上で避けるべきパターンや、可読性・保守性に優れた記述手法を整理しています。

以下は、pytest の `@pytest.mark` を中心に、テストの分類・制御・条件分岐に役立つ機能を体系的に整理した「第08部：markの活用」です。大規模テストの整理や実行効率の最適化に焦点を当てた実践的な構成です。

---

## 📍 第08部：markの活用

---

### 第43章：基本的なマークの使い方

* `@pytest.mark.xxx` の構文と意味
* `-m` オプションによるマーク指定実行
* 複数マークの組み合わせ（論理AND/ORの活用）

---

### 第44章：スキップと条件分岐

* `@pytest.mark.skip`：常にスキップするテスト
* `@pytest.mark.skipif(cond, reason="…")`：条件付きスキップ
* OS依存／バージョン依存テストの切り分け

---

### 第45章：失敗を許容するxfail

* `@pytest.mark.xfail` による意図的な失敗指定
* バグ修正待ち・仕様未定の暫定対応
* `strict=True` による「成功すると失敗扱い」設定

---

### 第46章：マークによるテスト分類設計

* `@pytest.mark.slow`、`@pytest.mark.api` などの任意マーク
* 大規模テストでの実行対象分離（夜間バッチ/CI高速化）
* 組織・チーム単位でのマーク運用ルールの設計

---

### 第47章：カスタムマークの登録と警告回避

* `pytest.ini` への `markers` 記述
* 外部APIを呼び出すテスト
* 未登録マークの警告防止とプロジェクトの明文化
* pytest-cov / pytest-html との連携におけるマークの影響

---

### 第48章：マークとフィルタの併用

* `-m "slow and not db"` のような実行フィルタ構成
* データベース接続が必要なテストだけを切り出す例
* `pytest --markers` によるマーク定義一覧確認

---

この部では、`mark` を単なるラベル以上のものとして捉え、**テストの分類・切り替え・戦略的スキップ**といった制御基盤として活用する方法を体系化しました。

次に「テストの安定性と再実行」「不安定テストの対策」などを含む **第09部：テスト安定性と再試行** への展開も可能です。ご希望があればお知らせください。

---

## 📍 第03部：テスト関数の詳解

---

### 第13章：命名と構成の原則

* `test_機能名_条件_期待結果` の命名規則
* Arrange → Act → Assert（AAAパターン）
* テスト1件につき1つの論点に絞る

### 第14章：繰返しパターンの整理

* `@pytest.mark.parametrize` による重複排除
* ループやif文の中でassertを書かない
* ケース数が増える場合の外部データ化

### 第15章：assertの使い方

* 単純な `assert a == b` の推奨
* 説明付き `assert expr, "期待値に関する補足"` の活用
* `in`・`is`・例外発生など多様な比較

### 第16章：副作用を避ける工夫

* 状態を変更する関数の後始末
* テストごとに初期化する工夫（fixture等）
* 外部依存（ファイル・DB）を隔離する

### 第17章：テスト失敗時の読みやすさ

* エラー出力がわかりやすいassert構文
* ログ出力の活用と出力抑制のバランス
* 再現性あるエラーメッセージの工夫

---

以下は「第04部：出力についての詳解」です。pytest実行時に得られる出力情報を最大限に活かすための構成で、失敗時の調査・デバッグ支援に重点を置いています。

---

## 📍 第04部：出力の詳解

---

### 第18章：デフォルト出力の構造

* ファイル名・関数名・テスト結果の並び
* `F`, `.` , `x`, `s` の記号の意味
* 実行順序と失敗時のソート順

### 第19章：失敗出力の読み解き

* `AssertionError` の差分比較
* `E       ` ラインの読み方
* トレースバックの開始地点の特定


### 第21章：標準出力・ログの制御

* `print()` の出力が見えない理由と `--capture=no`
* `capfd` / `caplog` フィクスチャによる検証
* ログ出力のテストとロガーの初期化

### 第22章：遅いテストの特定

* `--durations=5` による実行時間の測定
* ボトルネックとなる処理の検出
* 長時間テストの分離と分類
以下は「第05部：出力の可視化・CI」です。pytest出力の保存・共有・自動化をテーマに、CI環境との連携やレポート出力の実践的な方法を詳解しています。

---

## 📍 第05部：出力の可視化

---

### 第23章：junitxml形式の出力

* `--junitxml=report.xml` による結果の保存
* テストスイート、ケース、結果、エラー内容の構造
* CI/CDツール（GitHub Actions, Jenkins, GitLab CIなど）との互換性

---

### 第24章：HTMLレポート生成

* `pytest-html` プラグインの導入と使用方法

  * `pip install pytest-html`
  * `--html=report.html` によるHTML出力
* オプション：`--self-contained-html` で単一ファイル化
* 成功・失敗の視覚的強調とスクリーンショット埋め込み（Selenium等と併用）

---

### 第25章：マークダウン出力

* `pytest-md` によるMarkdown形式でのレポート出力

  * `--md-report report.md`
* 独自ログとの連携

  * `logging` モジュールと`caplog`の併用
  * 成果物としてログをCIに添付する方法（artifact化）

---


### 第27章：テストが失敗したケース

* `pytest-failures` での失敗履歴の保存と比較
* `pytest-rerunfailures` による再試行と安定化
* 通知との連携：Slack, Discord, GitHubのstatusチェック通知


---

## 📍 第06部：parametrizeの活用

---

### 第29章：基本的な使い方

* `@pytest.mark.parametrize` の構文と意味
* 複数の入力値・期待値を一括でテスト
* テスト関数1つで表現力を高めるパターン

---

### 第30章：複数引数のパラメータ化

* `(a, b, expected)` の形式で複数値を同時指定
* 複雑な条件分岐・境界値の網羅に適用
* 入力が多くてもテスト関数は1つに集約可能

---

### 第31章：識別子（ids）の活用

* `ids` パラメータによるテスト名の明示
* テスト実行ログの可読性向上
* 境界ケースやエッジケースの明示的識別に有効

---

### 第32章：外部データとの統合

* CSVやJSONなど外部ファイルからデータ読込
* `@pytest.mark.parametrize` との連携で柔軟な設計
* フレームワークとの連動（例：`pydantic`, `factory_boy`）

---

### 第33章：組合せテストの設計

* ネスト・多重パラメータ化による網羅
* `itertools.product()` を併用した全組合せ
* テストケースの肥大化防止と管理戦略

---

---

## 📍 第07部：fixtureの活用

---

### 第36章：fixtureの基本構文

* `@pytest.fixture` の定義と使用方法
* 引数による注入の仕組み
* returnによる値の注入とオブジェクト生成

---

### 第37章：実行タイミングの制御

* `scope="function"`（デフォルト）の意味
* `scope="module"` / `"session"` / `"class"` の使い分け
* 初期化コストの最適化と再利用性の調整

---

### 第38章：前処理・後処理の統合

* `yield` を使った setup/teardown の書き方
* `try/finally` との違いと注意点
* 一時ディレクトリ・DB接続・モック設定のクリーンアップ例

---

### 第39章：fixtureの依存とネスト

* fixtureからfixtureを呼び出す設計
* データ構築のステップ化と責務分離
* ネストが深くなる場合の整理法と可読性確保

---

### 第40章：conftest.pyによる共通化

* `conftest.py` にfixtureを定義する意義
* プロジェクト全体への適用とディレクトリ単位のスコープ
* import不要で利用可能な設計のベストプラクティス

---

### 第41章：条件付き・動的fixture

* 引数付きfixture（`request.param`）による柔軟な構成
* `pytest.mark.parametrize` との併用パターン
* 実行時に動的に切り替えるユースケース（例：DB種別、モード切替）

---

### 第42章：外部リソースのモックと注入

* ファイル、DB、Web API など外部依存の置き換え
* `monkeypatch` との併用によるパス差し替え
* Seleniumやrequestsを含む統合テストでの活用例

---
